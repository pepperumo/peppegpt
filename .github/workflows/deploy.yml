name: Deploy to Production

on:
  push:
    branches:
      - main
  workflow_dispatch:  # Allow manual trigger from GitHub UI

jobs:
  deploy:
    runs-on: ubuntu-latest

    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup SSH
        run: |
          mkdir -p ~/.ssh
          echo "${{ secrets.SSH_PRIVATE_KEY_BASE64 }}" | base64 -d > ~/.ssh/id_ed25519
          chmod 600 ~/.ssh/id_ed25519
          eval $(ssh-agent -s)
          ssh-add ~/.ssh/id_ed25519

      - name: Add server to known hosts
        run: |
          mkdir -p ~/.ssh
          ssh-keyscan -H srv1189800.hstgr.cloud >> ~/.ssh/known_hosts

      - name: Copy .env.prod to server
        run: |
          echo "${{ secrets.ENV_PROD_BASE64 }}" | base64 -d > .env.prod
          scp .env.prod root@srv1189800.hstgr.cloud:/root/peppegpt/.env

      - name: Sync project files
        run: |
          rsync -avz --delete \
            --exclude ".env" \
            --exclude ".env.local" \
            --exclude ".env.prod" \
            --exclude ".env.local.auradb" \
            --exclude "node_modules" \
            --exclude "venv" \
            --exclude ".venv" \
            --exclude "__pycache__" \
            --exclude ".git" \
            --exclude "*.pyc" \
            --exclude ".DS_Store" \
            ./ root@srv1189800.hstgr.cloud:/root/peppegpt/

      - name: Deploy containers
        run: |
          ssh root@srv1189800.hstgr.cloud "cd /root/peppegpt && docker compose down && docker compose up -d --build"

      - name: Health check
        run: |
          sleep 30
          ssh root@srv1189800.hstgr.cloud "docker ps --format 'table {{.Names}}\t{{.Status}}'"
